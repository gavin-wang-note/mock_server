<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mock Server 管理界面</title>
        <!-- Chart.js 本地链接 -->
        <script src="/static/Chart.js"></script>
        <!-- 加载超时处理 -->
        <script>
            // 检查 Chart.js 是否在 5 秒内加载完成
            setTimeout(function() {
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js 加载超时，使用备用方案');
                    // 创建一个简单的 Chart 模拟构造函数，避免错误
                    window.Chart = function(ctx, options) {
                        return {
                            destroy: function() {}
                        };
                    };
                    // 添加必要的静态属性
                    window.Chart.registry = {
                        addPlugin: function() {}
                    };
                }
            }, 5000);
        </script>
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #333;
            color: #fff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        nav {
            background-color: #444;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        nav ul {
            list-style: none;
            display: flex;
            gap: 15px;
        }
        
        nav ul li a {
            color: #fff;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: #555;
        }
        
        nav ul li a.active {
            background-color: #007bff;
            color: #fff;
        }
        
        .section {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: #fff;
        }
        
        .btn-primary:hover {
            background-color: #0069d9;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: #fff;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: #fff;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-success {
            background-color: #4caf50;
            color: #fff;
        }
        
        .btn-success:hover {
            background-color: #43a047;
        }
        
        .btn-warning {
            background-color: #ffb74d;
            color: #fff;
        }
        
        .btn-warning:hover {
            background-color: #ffa726;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 5px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-enabled {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-disabled {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .filter-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-form input, .filter-form select {
            flex: 1;
            min-width: 150px;
        }
        
        .request-detail {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        
        .request-detail pre {
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            nav ul {
                flex-direction: column;
                gap: 5px;
            }
            
            .filter-form {
                flex-direction: column;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 5px;
            }
        }
        
        /* 浮层提示样式 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast-content {
            display: flex;
            align-items: center;
        }
        
        .toast.error {
            background-color: #f44336;
        }
        
        .toast.info {
            background-color: #2196F3;
        }
        
        /* 排序样式 */
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: #e8e8e8;
        }
        
        .sort-icon {
            margin-left: 5px;
            font-size: 12px;
            color: #666;
        }
        
        .sort-icon.active {
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Mock Server 管理界面</h1>
            <p>企业级 Python Mock Server - 版本 V1.0.0</p>
        </header>
        
        <nav>
            <ul>
                <li><a href="#routes" class="tab-link active">路由管理</a></li>
                <li><a href="#requests" class="tab-link">请求历史</a></li>
                <li><a href="#config" class="tab-link">服务配置</a></li>
                <li><a href="#status" class="tab-link">服务状态</a></li>
            </ul>
        </nav>
        
        <!-- 路由管理 -->
        <div class="tab-content" id="routes-tab" style="display: block;">
            <h2>路由管理</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="openCreateRouteModal()">新增路由</button>
                    <button class="btn btn-secondary" onclick="importRoutes()">导入路由</button>
                    <button class="btn btn-success" onclick="exportRoutes()">导出路由</button>
                    <button class="btn btn-danger" id="batch-delete-btn" onclick="batchDeleteRoutes()" disabled>批量删除</button>
                </div>
                <div>
                    <input type="text" id="route-search" placeholder="搜索路由..." style="padding: 8px; width: 200px;">
                    <button class="btn btn-secondary" onclick="searchRoutes()">搜索</button>
                    <button class="btn btn-primary" onclick="resetRouteSearch()">重置</button>
                </div>
            </div>
            
            <!-- 导入路由文件输入 -->
            <input type="file" id="route-import-file" accept=".json" style="display: none;" onchange="handleRouteFileSelect(this)">
            
            <table id="routes-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-routes" onchange="toggleSelectAllRoutes(this)"></th>
                        <th class="sortable" onclick="sortRoutes('id')">
                            ID <span class="sort-icon" data-field="id">▲</span>
                        </th>
                        <th class="sortable" onclick="sortRoutes('name')">
                            名称 <span class="sort-icon" data-field="name">▲</span>
                        </th>
                        <th class="sortable" onclick="sortRoutes('path')">
                            路径 <span class="sort-icon" data-field="path">▲</span>
                        </th>
                        <th>方法</th>
                        <th>状态</th>
                        <th class="sortable" onclick="sortRoutes('created_at')">
                            创建时间 <span class="sort-icon" data-field="created_at">▼</span>
                        </th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for route in routes %}
                    <tr>
                        <td><input type="checkbox" class="route-checkbox" data-id="{{ route.id }}" onchange="updateBatchDeleteButton()"></td>
                        <td>{{ route.id[:8] }}...</td>
                        <td>{{ route.name }}</td>
                        <td>{{ route.match_rule.path }}</td>
                        <td>{{ route.match_rule.methods | join(', ') }}</td>
                        <td>
                            <span class="status-badge {{ 'status-enabled' if route.enabled else 'status-disabled' }}">
                                {{ '启用' if route.enabled else '禁用' }}
                            </span>
                        </td>
                        <td>{{ route.created_at | int | timestamp }}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editRoute('{{ route.id }}')">编辑</button>
                            <button class="btn {% if route.enabled %}btn-warning{% else %}btn-success{% endif %}" onclick="toggleRouteStatus('{{ route.id }}', {% if route.enabled %}false{% else %}true{% endif %})">{{ '禁用' if route.enabled else '启用' }}</button>
                            <button class="btn btn-danger" onclick="deleteRoute('{{ route.id }}')">删除</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- 分页控件 -->
            <div class="pagination-controls" style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: nowrap;">
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <label style="margin-right: 10px; white-space: nowrap;">每页显示：</label>
                    <select id="routes-page-size" onchange="changeRoutesPageSize()" style="margin-right: 10px;">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center;">
                    <button class="btn btn-secondary" onclick="changeRoutesPage(1)" id="routes-first-page">首页</button>
                    <button class="btn btn-secondary" onclick="changeRoutesPage(routesPagination.currentPage - 1)" id="routes-prev-page">上一页</button>
                    <span id="routes-page-info" style="margin: 0 10px;">第 1 页，共 1 页，共 0 条</span>
                    <button class="btn btn-secondary" onclick="changeRoutesPage(routesPagination.currentPage + 1)" id="routes-next-page">下一页</button>
                    <button class="btn btn-secondary" onclick="changeRoutesPage(routesPagination.totalPages)" id="routes-last-page">末页</button>
                </div>
            </div>
        </div>
        
        <!-- 请求历史 -->
        <div class="tab-content" id="requests-tab" style="display: none;">
            <h2>请求历史</h2>
            <div class="filter-form">
                <select id="request-method" placeholder="方法">
                    <option value="">所有方法</option>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                </select>
                <input type="text" id="request-path" placeholder="路径包含">
                <input type="number" id="request-status" placeholder="状态码">
                <button class="btn btn-primary" onclick="filterRequests()">过滤</button>
                <button class="btn btn-secondary" onclick="clearFilters()">重置</button>
                <button class="btn btn-danger" onclick="clearRequests()">清空历史</button>
            </div>
            
            <table id="requests-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortRequests('timestamp')">
                            时间 <span class="sort-icon" data-field="timestamp">▼</span>
                        </th>
                        <th class="sortable" onclick="sortRequests('method')">
                            方法 <span class="sort-icon" data-field="method">▲</span>
                        </th>
                        <th class="sortable" onclick="sortRequests('path')">
                            路径 <span class="sort-icon" data-field="path">▲</span>
                        </th>
                        <th class="sortable" onclick="sortRequests('response_status')">
                            状态码 <span class="sort-icon" data-field="response_status">▲</span>
                        </th>
                        <th class="sortable" onclick="sortRequests('response_time')">
                            响应时间 <span class="sort-icon" data-field="response_time">▲</span>
                        </th>
                        <th class="sortable" onclick="sortRequests('client_ip')">
                            客户端IP <span class="sort-icon" data-field="client_ip">▲</span>
                        </th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr>
                        <td>{{ req.timestamp | int | timestamp }}</td>
                        <td>{{ req.method }}</td>
                        <td>{{ req.path }}</td>
                        <td>{{ req.response_status }}</td>
                        <td>{{ "{:.3f}".format(req.response_time) }}s</td>
                        <td>{{ req.client_ip }}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewRequest('{{ req.id }}')">查看</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- 分页控件 -->
            <div class="pagination-controls" style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: nowrap;">
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <label style="margin-right: 10px; white-space: nowrap;">每页显示：</label>
                    <select id="requests-page-size" onchange="changeRequestsPageSize()" style="margin-right: 10px;">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center;">
                    <button class="btn btn-secondary" onclick="changeRequestsPage(1)" id="requests-first-page">首页</button>
                    <button class="btn btn-secondary" onclick="changeRequestsPage(requestsPagination.currentPage - 1)" id="requests-prev-page">上一页</button>
                    <span id="requests-page-info" style="margin: 0 10px;">第 1 页，共 1 页，共 0 条</span>
                    <button class="btn btn-secondary" onclick="changeRequestsPage(requestsPagination.currentPage + 1)" id="requests-next-page">下一页</button>
                    <button class="btn btn-secondary" onclick="changeRequestsPage(requestsPagination.totalPages)" id="requests-last-page">末页</button>
                </div>
            </div>
        </div>
        
        <!-- 服务配置 -->
        <div class="tab-content" id="config-tab" style="display: none;">
            <h2>服务配置</h2>
            <form id="config-form">
                <div class="form-group">
                    <label>服务器地址</label>
                    <input type="text" id="server-host" value="0.0.0.0" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label>服务器端口</label>
                    <input type="number" id="server-port" value="{{ config.server.port }}" min="1" max="65535">
                    <small id="port-error" style="color: red; display: none;"></small>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="enable-https" {% if config.server.enable_https %}checked{% endif %}>
                    <label for="enable-https" style="margin-bottom: 0;">启用HTTPS</label>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="enable-proxy" {% if config.proxy.enable %}checked{% endif %} onchange="toggleProxyInput()">
                    <label for="enable-proxy" style="margin-bottom: 0;">启用代理模式</label>
                </div>
                <div class="form-group">
                    <label>代理目标URL</label>
                    <input type="text" id="proxy-target" value="{{ config.proxy.target_url or '' }}" {% if not config.proxy.enable %}disabled style="background-color: #f5f5f5; cursor: not-allowed;"{% endif %}>
                    <small id="proxy-error" style="color: red; display: none;"></small>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">保存配置</button>
                    <button type="button" class="btn btn-secondary" onclick="restoreDefaultConfig()">恢复默认</button>
                </div>
                <div id="save-message" style="margin-top: 10px; padding: 10px; border-radius: 3px; display: none;"></div>
            </form>
        </div>
        
        <!-- 服务状态 -->
        <div class="tab-content" id="status-tab" style="display: none;">
            <h2>服务状态</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="request-detail">
                    <h3>运行时间</h3>
                    <p id="uptime">计算中...</p>
                </div>
                <div class="request-detail">
                    <h3>总请求数</h3>
                    <p id="total-requests">{{ requests | length }}</p>
                </div>
                <div class="request-detail">
                    <h3>活跃路由</h3>
                    <p id="active-routes">{{ routes | selectattr('enabled', 'equalto', true) | list | length }}</p>
                </div>
                <div class="request-detail">
                    <h3>服务状态</h3>
                    <p id="service-status" class="status-badge status-enabled">运行中</p>
                </div>
            </div>
            
            <!-- 数据统计和分析 -->
            <h3>数据统计和分析</h3>
            <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; white-space: nowrap;">
                <label style="font-weight: normal;">统计时间范围：</label>
                <select id="analytics-hours" onchange="updateAnalytics()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 3px; width: 120px;">
                    <option value="1" selected>1小时</option>
                    <option value="6">6小时</option>
                    <option value="24">24小时</option>
                    <option value="48">48小时</option>
                    <option value="72">72小时</option>
                    <option value="168">7天</option>
                </select>
                <button class="btn btn-primary" onclick="updateAnalytics()" style="background-color: #1890ff; border-color: #1890ff;">更新数据</button>
            </div>
            
            <!-- 请求趋势图表 -->
            <div class="request-detail" style="margin-bottom: 20px;">
                <h4>请求趋势</h4>
                <div style="width: 100%; height: 300px;">
                    <canvas id="request-trend-chart"></canvas>
                </div>
            </div>
            
            <!-- 响应时间统计 -->
            <div class="request-detail" style="margin-bottom: 20px;">
                <h4>响应时间统计</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <p><strong>平均响应时间：</strong><span id="avg-response-time">0</span>ms</p>
                    </div>
                    <div>
                        <p><strong>最小响应时间：</strong><span id="min-response-time">0</span>ms</p>
                    </div>
                    <div>
                        <p><strong>最大响应时间：</strong><span id="max-response-time">0</span>ms</p>
                    </div>
                    <div>
                        <p><strong>P95响应时间：</strong><span id="p95-response-time">0</span>ms</p>
                    </div>
                </div>
            </div>
            
            <!-- 状态码统计 -->
            <div class="request-detail" style="margin-bottom: 20px;">
                <h4>状态码统计</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                    <div>
                        <p><strong>2xx：</strong><span id="status-2xx">0</span></p>
                    </div>
                    <div>
                        <p><strong>3xx：</strong><span id="status-3xx">0</span></p>
                    </div>
                    <div>
                        <p><strong>4xx：</strong><span id="status-4xx">0</span></p>
                    </div>
                    <div>
                        <p><strong>5xx：</strong><span id="status-5xx">0</span></p>
                    </div>
                </div>
            </div>
            
            <!-- 请求方法统计 -->
            <div class="request-detail" style="margin-bottom: 20px;">
                <h4>请求方法统计</h4>
                <div style="width: 100%; height: 300px;">
                    <canvas id="method-stats-chart"></canvas>
                </div>
            </div>
            
            <!-- 热门路径统计 -->
            <div class="request-detail" style="margin-bottom: 20px;">
                <h4>热门路径</h4>
                <table id="hot-paths-table">
                    <thead>
                        <tr>
                            <th>路径</th>
                            <th>请求数</th>
                            <th>平均响应时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 创建路由模态框 -->
    <div id="create-route-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateRouteModal()">&times;</span>
            <h2>新增路由</h2>
            <form id="create-route-form">
                <div class="form-group">
                    <label>路由名称</label>
                    <input type="text" id="route-name" required>
                </div>
                <div class="form-group">
                    <label>路径</label>
                    <input type="text" id="route-path" placeholder="例如: /api/users/{id}" required>
                </div>
                <div class="form-group">
                    <label>HTTP方法</label>
                    <input type="text" id="route-methods" placeholder="例如: GET,POST" required>
                </div>
                <div class="form-group">
                    <label>状态码</label>
                    <input type="number" id="route-status" value="200" required>
                </div>
                <div class="form-group">
                    <label>响应内容</label>
                    <textarea id="route-content" placeholder='例如: {"id": "1", "name": "User"}' required></textarea>
                </div>
                <div class="form-group">
                    <label>响应延迟 (秒)</label>
                    <input type="number" id="route-delay" value="0" step="0.1">
                </div>
                <button type="button" class="btn btn-primary" onclick="submitCreateRoute()">创建</button>
                <button type="button" class="btn btn-secondary" onclick="closeCreateRouteModal()">取消</button>
            </form>
        </div>
    </div>
    
    <!-- 请求详情模态框 -->
    <div id="request-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRequestDetailModal()">&times;</span>
            <h2>请求详情</h2>
            <div id="request-detail-content"></div>
        </div>
    </div>
    
    <!-- 编辑路由模态框 -->
    <div id="edit-route-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditRouteModal()">&times;</span>
            <h2>编辑路由</h2>
            <form id="edit-route-form">
                <input type="hidden" id="edit-route-id">
                <div class="form-group">
                    <label>路由名称</label>
                    <input type="text" id="edit-route-name" required>
                </div>
                <div class="form-group">
                    <label>路径</label>
                    <input type="text" id="edit-route-path" placeholder="例如: /api/users/{id}" required>
                </div>
                <div class="form-group">
                    <label>HTTP方法</label>
                    <input type="text" id="edit-route-methods" placeholder="例如: GET,POST" required>
                </div>
                <div class="form-group">
                    <label>状态码</label>
                    <input type="number" id="edit-route-status" value="200" required>
                </div>
                <div class="form-group">
                    <label>响应内容</label>
                    <textarea id="edit-route-content" placeholder='例如: {"id": "1", "name": "User"}' required></textarea>
                </div>
                <div class="form-group">
                    <label>响应延迟 (秒)</label>
                    <input type="number" id="edit-route-delay" value="0" step="0.1">
                </div>
                <div class="form-group">
                    <label>启用状态</label>
                    <select id="edit-route-enabled">
                        <option value="true">启用</option>
                        <option value="false">禁用</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary" onclick="submitEditRoute()">保存</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditRouteModal()">取消</button>
            </form>
        </div>
    </div>
    
    <!-- 浮层提示组件 -->
    <div id="toast-message" class="toast">
        <div class="toast-content">
            <span id="toast-text"></span>
        </div>
    </div>
    
    <script>
        // 时间戳转换为日期时间
        function timestampToDateTime(timestamp) {
            const date = new Date(timestamp * 1000);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // 显示浮层提示
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast-message');
            const toastText = document.getElementById('toast-text');
            
            // 设置消息和类型
            toastText.textContent = message;
            toast.className = 'toast';
            toast.classList.add(type);
            
            // 显示提示
            toast.classList.add('show');
            
            // 定时隐藏
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // 更新路由列表
        function updateRoutesList() {
            const offset = (routesPagination.currentPage - 1) * routesPagination.pageSize;
            
            // 构建查询参数
            let queryParams = new URLSearchParams();
            queryParams.append('limit', routesPagination.pageSize);
            queryParams.append('offset', offset);
            queryParams.append('sort', routesSortField);
            queryParams.append('order', routesSortOrder);
            
            fetch(`/admin/routes?${queryParams.toString()}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#routes-table tbody');
                tbody.innerHTML = '';
                
                // 使用后端返回的新数据结构
                const routesArray = data.items || [];
                
                if (routesArray.length === 0) {
                    // 显示空数据提示
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            <p>暂无路由数据</p>
                            <p style="margin-top: 10px;">点击"新增路由"按钮添加第一条路由</p>
                        </td>
                    `;
                    tbody.appendChild(row);
                    
                    // 更新分页信息
                    routesPagination.updatePaginationInfo(0);
                } else {
                    // 显示路由列表
                    routesArray.forEach(route => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" class="route-checkbox" data-id="${route.id}" onchange="updateBatchDeleteButton()"></td>
                            <td>${route.id.substring(0, 8)}...</td>
                            <td>${route.name}</td>
                            <td>${route.match_rule ? route.match_rule.path : ''}</td>
                            <td>${route.match_rule ? route.match_rule.methods.join(', ') : ''}</td>
                            <td>
                                <span class="status-badge ${route.enabled ? 'status-enabled' : 'status-disabled'}">
                                    ${route.enabled ? '启用' : '禁用'}
                                </span>
                            </td>
                            <td>${route.created_at ? timestampToDateTime(route.created_at) : ''}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editRoute('${route.id}')">编辑</button>
                                <button class="btn ${route.enabled ? 'btn-warning' : 'btn-success'}" onclick="toggleRouteStatus('${route.id}', ${!route.enabled})">${route.enabled ? '禁用' : '启用'}</button>
                                <button class="btn btn-danger" onclick="deleteRoute('${route.id}')">删除</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // 更新分页信息
                    routesPagination.updatePaginationInfo(data.total || routesArray.length);
                }
            })
            .catch(error => {
                showToast('更新路由列表失败：' + error.message, 'error');
            });
        }
        
        // 格式化时间戳
        document.addEventListener('DOMContentLoaded', function() {
            // 计算运行时间
            
            // 首次获取服务启动时间
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    // 计算服务启动时间并存储到全局变量
                    window.serviceStartTime = Date.now() - (data.uptime * 1000);
                    // 开始更新运行时间
                    updateUptime();
                });
            
            // 每5秒更新一次运行时间（在客户端计算）
            setInterval(updateUptime, 5000);
            
            // 搜索路由
            document.getElementById('route-search').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchRoutes();
                }
            });
        });
        
        function updateUptime() {
            // 检查是否已经获取了服务启动时间
            if (window.serviceStartTime === undefined) {
                // 如果没有，就获取一次
                fetch('/health')
                    .then(response => response.json())
                    .then(data => {
                        // 计算服务启动时间并存储
                        window.serviceStartTime = Date.now() - (data.uptime * 1000);
                        console.log('服务启动时间已设置:', window.serviceStartTime);
                        // 更新运行时间
                        updateUptimeDisplay();
                    })
                    .catch(error => {
                        console.error('获取健康检查数据失败:', error);
                    });
            } else {
                // 如果已经有了，就直接在客户端计算
                updateUptimeDisplay();
            }
        }
        
        function updateUptimeDisplay() {
            // 计算当前运行时间（秒）
            const uptime = (Date.now() - window.serviceStartTime) / 1000;
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = Math.floor(uptime % 60);
            document.getElementById('uptime').textContent = `${hours}h ${minutes}m ${seconds}s`;
        }
        
        // 路由管理
        function openCreateRouteModal() {
            document.getElementById('create-route-modal').style.display = 'block';
        }
        
        function closeCreateRouteModal() {
            document.getElementById('create-route-modal').style.display = 'none';
            document.getElementById('create-route-form').reset();
        }
        
        function submitCreateRoute() {
            const name = document.getElementById('route-name').value;
            const path = document.getElementById('route-path').value;
            const methods = document.getElementById('route-methods').value.split(',').map(m => m.trim());
            const status = parseInt(document.getElementById('route-status').value);
            const content = document.getElementById('route-content').value;
            const delay = parseFloat(document.getElementById('route-delay').value);
            
            // 验证必填项
            if (!path) {
                showToast('路径不能为空', 'error');
                return;
            }
            if (methods.length === 0 || methods[0] === '') {
                showToast('HTTP方法不能为空', 'error');
                return;
            }
            if (!content) {
                showToast('响应内容不能为空', 'error');
                return;
            }
            
            let routeContent;
            try {
                routeContent = JSON.parse(content);
            } catch (e) {
                showToast('响应内容必须是有效的JSON格式', 'error');
                return;
            }
            
            const routeData = {
                name: name,
                match_rule: {
                    path: path,
                    methods: methods
                },
                response: {
                    status: status,
                    content: routeContent,
                    delay: delay
                }
            };
            
            fetch('/admin/routes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer mock_server_admin_token'
                },
                body: JSON.stringify(routeData)
            })
            .then(response => response.json())
            .then(data => {
                showToast('路由创建成功！');
                closeCreateRouteModal();
                updateRoutesList();
            })
            .catch(error => {
                showToast('路由创建失败：' + error.message, 'error');
            });
        }
        
        function editRoute(routeId) {
            // 获取路由详情
            fetch(`/admin/routes/${routeId}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(route => {
                // 填充表单
                document.getElementById('edit-route-id').value = route.id || '';
                document.getElementById('edit-route-name').value = route.name || '';
                document.getElementById('edit-route-path').value = (route.match_rule && route.match_rule.path) || '';
                document.getElementById('edit-route-methods').value = (route.match_rule && route.match_rule.methods) ? route.match_rule.methods.join(', ') : '';
                document.getElementById('edit-route-status').value = (route.response && route.response.status) || 200;
                document.getElementById('edit-route-content').value = JSON.stringify((route.response && route.response.content) || { message: "响应内容" }, null, 2);
                document.getElementById('edit-route-delay').value = (route.response && route.response.delay) || 0;
                document.getElementById('edit-route-enabled').value = route.enabled !== false;
                
                // 显示模态框
                document.getElementById('edit-route-modal').style.display = 'block';
            })
            .catch(error => {
                alert('获取路由详情失败：' + error.message);
            });
        }
        
        function closeEditRouteModal() {
            document.getElementById('edit-route-modal').style.display = 'none';
            document.getElementById('edit-route-form').reset();
        }
        
        function submitEditRoute() {
            const routeId = document.getElementById('edit-route-id').value;
            const name = document.getElementById('edit-route-name').value;
            const path = document.getElementById('edit-route-path').value;
            const methods = document.getElementById('edit-route-methods').value.split(',').map(m => m.trim());
            const status = parseInt(document.getElementById('edit-route-status').value);
            const contentStr = document.getElementById('edit-route-content').value;
            
            // 验证必填项
            if (!path) {
                showToast('路径不能为空', 'error');
                return;
            }
            if (methods.length === 0 || methods[0] === '') {
                showToast('HTTP方法不能为空', 'error');
                return;
            }
            if (!contentStr) {
                showToast('响应内容不能为空', 'error');
                return;
            }
            
            let content;
            try {
                content = JSON.parse(contentStr);
            } catch (e) {
                showToast('响应内容必须是有效的JSON格式', 'error');
                return;
            }
            const delay = parseFloat(document.getElementById('edit-route-delay').value);
            const enabled = document.getElementById('edit-route-enabled').value === 'true';
            
            const routeData = {
                name: name,
                match_rule: {
                    path: path,
                    methods: methods
                },
                response: {
                    status: status,
                    content: content,
                    delay: delay
                },
                enabled: enabled
            };
            
            fetch(`/admin/routes/${routeId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(routeData)
            })
            .then(response => response.json())
            .then(data => {
                showToast('路由编辑成功！');
                closeEditRouteModal();
                updateRoutesList();
            })
            .catch(error => {
                showToast('路由编辑失败：' + error.message, 'error');
            });
        }
        
        function deleteRoute(routeId) {
            if (confirm('确定要删除此路由吗？')) {
                fetch(`/admin/routes/${routeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer mock_server_admin_token'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    showToast('路由删除成功！');
                    updateRoutesList();
                })
                .catch(error => {
                    showToast('路由删除失败：' + error.message, 'error');
                });
            }
        }
        
        function toggleSelectAllRoutes(checkbox) {
            const checkboxes = document.querySelectorAll('.route-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateBatchDeleteButton();
        }
        
        function updateBatchDeleteButton() {
            const checkedBoxes = document.querySelectorAll('.route-checkbox:checked');
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            batchDeleteBtn.disabled = checkedBoxes.length === 0;
        }
        
        function batchDeleteRoutes() {
            const checkedBoxes = document.querySelectorAll('.route-checkbox:checked');
            const routeIds = Array.from(checkedBoxes).map(cb => cb.dataset.id);
            
            if (routeIds.length === 0) {
                showToast('请选择要删除的路由', 'warning');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${routeIds.length} 个路由吗？`)) {
                // 批量删除路由
                const deletePromises = routeIds.map(routeId => {
                    return fetch(`/admin/routes/${routeId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer mock_server_admin_token'
                        }
                    }).then(response => {
                        if (!response.ok) {
                            throw new Error('删除失败');
                        }
                        return response.json();
                    });
                });
                
                Promise.all(deletePromises)
                .then(results => {
                    showToast(`成功删除 ${results.length} 个路由！`);
                    updateRoutesList();
                    // 取消全选复选框的勾选状态
                    document.getElementById('select-all-routes').checked = false;
                })
                .catch(error => {
                    showToast('批量删除失败：' + error.message, 'error');
                });
            }
        }
        
        function toggleRouteStatus(routeId, enabled) {
            // 发送请求更新路由状态
            fetch(`/admin/routes/${routeId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                showToast(`路由已${enabled ? '启用' : '禁用'}！`);
                updateRoutesList();
            })
            .catch(error => {
                showToast('更新路由状态失败：' + error.message, 'error');
            });
        }
        
        function searchRoutes() {
            const searchTerm = document.getElementById('route-search').value;
            
            // 构建查询参数
            let queryParams = new URLSearchParams();
            if (searchTerm) {
                queryParams.append('search', searchTerm);
            }
            
            // 添加分页参数
            queryParams.append('limit', routesPagination.pageSize);
            queryParams.append('offset', 0); // 重置为第一页
            
            // 重置页码
            routesPagination.currentPage = 1;
            
            // 从后端获取数据
            fetch(`/admin/routes?${queryParams.toString()}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#routes-table tbody');
                tbody.innerHTML = '';
                
                const routes = data.items || [];
                
                if (routes.length === 0) {
                    // 显示空数据提示
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            <p>暂无查询记录</p>
                            <p style="margin-top: 10px;">未找到与"${searchTerm}"相关的路由</p>
                        </td>
                    `;
                    tbody.appendChild(row);
                    
                    // 更新分页信息
                    routesPagination.updatePaginationInfo(0);
                } else {
                    // 显示路由列表
                    routes.forEach(route => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" class="route-checkbox" data-id="${route.id}" onchange="updateBatchDeleteButton()"></td>
                            <td>${route.id.substring(0, 8)}...</td>
                            <td>${route.name}</td>
                            <td>${route.match_rule ? route.match_rule.path : ''}</td>
                            <td>${route.match_rule ? route.match_rule.methods.join(', ') : ''}</td>
                            <td>
                                <span class="status-badge ${route.enabled ? 'status-enabled' : 'status-disabled'}">
                                    ${route.enabled ? '启用' : '禁用'}
                                </span>
                            </td>
                            <td>${route.created_at ? timestampToDateTime(route.created_at) : ''}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editRoute('${route.id}')">编辑</button>
                                <button class="btn ${route.enabled ? 'btn-warning' : 'btn-success'}" onclick="toggleRouteStatus('${route.id}', ${!route.enabled})">${route.enabled ? '禁用' : '启用'}</button>
                                <button class="btn btn-danger" onclick="deleteRoute('${route.id}')">删除</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // 更新分页信息
                    routesPagination.currentPage = 1;
                    routesPagination.updatePaginationInfo(data.total || routes.length);
                }
            })
            .catch(error => {
                showToast('搜索路由失败：' + error.message, 'error');
            });
        }
        
        function resetRouteSearch() {
            // 清空搜索输入框
            document.getElementById('route-search').value = '';
            // 更新路由列表，确保显示所有路由
            updateRoutesList();
        }
        
        // 导出路由功能
        function exportRoutes() {
            // 创建一个带有认证头的请求
            fetch('/admin/routes-export', {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // 从响应头获取文件名
                const contentDisposition = response.headers.get('content-disposition');
                let fileName = 'routes_export.json';
                if (contentDisposition) {
                    const matches = /filename="([^"]+)"/.exec(contentDisposition);
                    if (matches && matches[1]) {
                        fileName = matches[1];
                    }
                }
                return response.blob().then(blob => ({
                    blob,
                    fileName
                }));
            })
            .then(data => {
                // 创建一个下载链接
                const url = window.URL.createObjectURL(data.blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = data.fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('路由导出成功！');
            })
            .catch(error => {
                showToast('路由导出失败：' + error.message, 'error');
            });
        }
        
        // 导入路由功能
        function importRoutes() {
            // 打开文件选择对话框
            document.getElementById('route-import-file').click();
        }
        
        function handleRouteFileSelect(input) {
            const file = input.files[0];
            if (!file) {
                return;
            }
            
            // 检查文件类型
            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                showToast('请选择JSON格式的文件', 'error');
                input.value = ''; // 清空文件输入
                return;
            }
            
            // 读取文件内容
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // 解析JSON
                    const routesData = JSON.parse(e.target.result);
                    
                    // 检查解析结果是否为数组
                    if (!Array.isArray(routesData)) {
                        showToast('JSON文件格式错误，应为路由数组', 'error');
                        input.value = '';
                        return;
                    }
                    
                    // 确认导入（直接覆盖）
                    if (confirm('确定要导入路由吗？这将直接覆盖现有所有路由。')) {
                        // 导入路由
                        importRoutesData(routesData);
                    }
                } catch (error) {
                    showToast('JSON格式错误：' + error.message, 'error');
                } finally {
                    input.value = ''; // 清空文件输入
                }
            };
            reader.onerror = function() {
                showToast('文件读取失败', 'error');
                input.value = '';
            };
            reader.readAsText(file);
        }
        
        function importRoutesData(routesData) {
            // 首先获取所有现有路由
            fetch('/admin/routes', {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(existingRoutes => {
                // 确保 existingRoutes 是一个数组
                const routesToDelete = Array.isArray(existingRoutes) ? existingRoutes : [];
                // 批量删除现有路由
                const deletePromises = routesToDelete.map(route => {
                    return fetch(`/admin/routes/${route.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer mock_server_admin_token'
                        }
                    });
                });
                
                return Promise.all(deletePromises);
            })
            .then(() => {
                // 批量添加新路由
                const addPromises = routesData.map(routeData => {
                    // 确保路由数据格式正确
                    const route = {
                        name: routeData.name,
                        match_rule: routeData.match_rule,
                        response: routeData.response,
                        enabled: routeData.enabled !== false,
                        validator: routeData.validator,
                        tags: routeData.tags
                    };
                    
                    return fetch('/admin/routes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer mock_server_admin_token'
                        },
                        body: JSON.stringify(route)
                    });
                });
                
                return Promise.all(addPromises);
            })
            .then(() => {
                // 更新路由列表
                updateRoutesList();
                // 显示成功提示
                showToast(`成功导入 ${routesData.length} 条路由`, 'success');
            })
            .catch(error => {
                // 显示错误提示
                showToast('路由导入失败：' + error.message, 'error');
            });
        }
        
        // 请求历史管理
        function filterRequests() {
            const method = document.getElementById('request-method').value;
            const path = document.getElementById('request-path').value;
            const status = document.getElementById('request-status').value;
            
            // 构建查询参数
            let queryParams = new URLSearchParams();
            if (method) {
                queryParams.append('method', method);
            }
            if (path) {
                queryParams.append('path', path);
            }
            if (status) {
                queryParams.append('status_code', status);
            }
            
            // 添加分页参数
            queryParams.append('limit', requestsPagination.pageSize);
            queryParams.append('offset', (requestsPagination.currentPage - 1) * requestsPagination.pageSize);
            
            // 从后端获取过滤后的数据
            fetch(`/admin/requests?${queryParams.toString()}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#requests-table tbody');
                tbody.innerHTML = '';
                
                const requests = data.items || [];
                
                if (requests.length === 0) {
                    // 显示空数据提示
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            <p>暂无查询记录</p>
                            <p style="margin-top: 10px;">未找到符合条件的请求历史</p>
                        </td>
                    `;
                    tbody.appendChild(row);
                    
                    // 更新分页信息
                    requestsPagination.updatePaginationInfo(data.total || 0);
                } else {
                    // 显示请求历史列表
                    requests.forEach(req => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${timestampToDateTime(req.timestamp)}</td>
                            <td>${req.method}</td>
                            <td>${req.path}</td>
                            <td>${req.response_status}</td>
                            <td>${req.response_time.toFixed(3)}s</td>
                            <td>${req.client_ip}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewRequest('${req.id}')">查看</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // 更新分页信息
                    requestsPagination.updatePaginationInfo(data.total || requests.length);
                }
            })
            .catch(error => {
                showToast('过滤请求失败：' + error.message, 'error');
            });
        }
        
        function clearFilters() {
            document.getElementById('request-method').value = '';
            document.getElementById('request-path').value = '';
            document.getElementById('request-status').value = '';
            updateRequestsList();
        }
        
        function clearRequests() {
            if (confirm('确定要清空所有请求历史吗？')) {
                fetch('/admin/requests', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer mock_server_admin_token'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    showToast('请求历史清空成功！');
                    updateRequestsList();
                })
                .catch(error => {
                    showToast('请求历史清空失败：' + error.message, 'error');
                });
            }
        }
        
        // 更新请求历史列表
        function updateRequestsList() {
            const offset = (requestsPagination.currentPage - 1) * requestsPagination.pageSize;
            
            // 构建查询参数
            let queryParams = new URLSearchParams();
            queryParams.append('limit', requestsPagination.pageSize);
            queryParams.append('offset', offset);
            queryParams.append('sort', requestsSortField);
            queryParams.append('order', requestsSortOrder);
            
            fetch(`/admin/requests?${queryParams.toString()}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#requests-table tbody');
                tbody.innerHTML = '';
                
                const requests = data.items || [];
                
                if (requests.length === 0) {
                    // 显示空数据提示
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            <p>暂无请求历史数据</p>
                            <p style="margin-top: 10px;">当有请求访问API时，这里会显示请求历史</p>
                        </td>
                    `;
                    tbody.appendChild(row);
                    
                    // 更新分页信息
                    requestsPagination.updatePaginationInfo(data.total || 0);
                } else {
                    // 显示请求历史列表
                    requests.forEach(req => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${timestampToDateTime(req.timestamp)}</td>
                            <td>${req.method}</td>
                            <td>${req.path}</td>
                            <td>${req.response_status}</td>
                            <td>${req.response_time.toFixed(3)}s</td>
                            <td>${req.client_ip}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewRequest('${req.id}')">查看</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // 更新分页信息
                    requestsPagination.updatePaginationInfo(data.total || requests.length);
                }
            })
            .catch(error => {
                showToast('更新请求历史失败：' + error.message, 'error');
            });
        }
        
        function viewRequest(requestId) {
            fetch(`/admin/requests/${requestId}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                const modal = document.getElementById('request-detail-modal');
                const content = document.getElementById('request-detail-content');
                
                content.innerHTML = `
                    <div class="request-detail">
                        <h3>请求信息</h3>
                        <p><strong>时间：</strong>${timestampToDateTime(data.request.timestamp)}</p>
                        <p><strong>方法：</strong>${data.request.method}</p>
                        <p><strong>路径：</strong>${data.request.path}</p>
                        <p><strong>状态码：</strong>${data.request.response_status}</p>
                        <p><strong>响应时间：</strong>${data.request.response_time}s</p>
                        <p><strong>客户端IP：</strong>${data.request.client_ip}</p>
                        <p><strong>查询参数：</strong></p>
                        <pre>${JSON.stringify(data.request.query_params, null, 2)}</pre>
                        <p><strong>请求体：</strong></p>
                        <pre>${JSON.stringify(data.request.body, null, 2)}</pre>
                    </div>
                    <div class="request-detail" style="margin-top: 10px;">
                        <h3>响应信息</h3>
                        <p><strong>状态码：</strong>${data.response.status_code}</p>
                        <p><strong>响应时间：</strong>${data.response.response_time}s</p>
                        <p><strong>内容类型：</strong>${data.response.content_type}</p>
                        <p><strong>响应内容：</strong></p>
                        <pre>${typeof data.response.content === 'string' ? data.response.content : JSON.stringify(data.response.content, null, 2)}</pre>
                    </div>
                `;
                
                modal.style.display = 'block';
            })
            .catch(error => {
                alert('获取请求详情失败：' + error.message);
            });
        }
        
        function closeRequestDetailModal() {
            document.getElementById('request-detail-modal').style.display = 'none';
        }
        
        // 切换代理输入框状态
        function toggleProxyInput() {
            const enableProxy = document.getElementById('enable-proxy').checked;
            const proxyTarget = document.getElementById('proxy-target');
            
            if (enableProxy) {
                proxyTarget.disabled = false;
                proxyTarget.style.backgroundColor = '#ffffff';
                proxyTarget.style.cursor = 'text';
            } else {
                proxyTarget.disabled = true;
                proxyTarget.style.backgroundColor = '#f5f5f5';
                proxyTarget.style.cursor = 'not-allowed';
            }
        }
        
        // 恢复默认配置
        function restoreDefaultConfig() {
            if (confirm('确定要恢复默认配置吗？这将覆盖当前的所有配置设置。')) {
                // 默认配置
                const defaultConfig = {
                    server: {
                        host: '0.0.0.0',
                        port: 8080,
                        enable_https: false
                    },
                    proxy: {
                        enable: false,
                        target_url: ''
                    }
                };
                
                // 更新表单
                document.getElementById('server-port').value = defaultConfig.server.port;
                document.getElementById('enable-https').checked = defaultConfig.server.enable_https;
                document.getElementById('enable-proxy').checked = defaultConfig.proxy.enable;
                document.getElementById('proxy-target').value = defaultConfig.proxy.target_url;
                
                // 切换代理输入框状态
                toggleProxyInput();
                
                // 保存默认配置
                fetch('/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer mock_server_admin_token'
                    },
                    body: JSON.stringify(defaultConfig)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('保存失败：' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    // 显示成功提示
                    const saveMessage = document.getElementById('save-message');
                    saveMessage.textContent = '默认配置恢复成功！';
                    saveMessage.style.backgroundColor = '#d4edda';
                    saveMessage.style.color = '#155724';
                    saveMessage.style.display = 'block';
                    
                    // 3秒后隐藏提示
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                    }, 3000);
                })
                .catch(error => {
                    // 显示失败提示
                    const saveMessage = document.getElementById('save-message');
                    saveMessage.textContent = '默认配置恢复失败：' + error.message;
                    saveMessage.style.backgroundColor = '#f8d7da';
                    saveMessage.style.color = '#721c24';
                    saveMessage.style.display = 'block';
                });
            }
        }
        
        // 服务配置管理
        function saveConfig() {
            // 重置错误提示
            document.getElementById('port-error').style.display = 'none';
            document.getElementById('proxy-error').style.display = 'none';
            document.getElementById('save-message').style.display = 'none';
            
            // 获取表单数据
            const port = parseInt(document.getElementById('server-port').value);
            const enableHttps = document.getElementById('enable-https').checked;
            const enableProxy = document.getElementById('enable-proxy').checked;
            const proxyTarget = document.getElementById('proxy-target').value;
            
            // 端口校验
            if (isNaN(port) || port < 1 || port > 65535) {
                document.getElementById('port-error').textContent = '端口号必须在1-65535之间';
                document.getElementById('port-error').style.display = 'block';
                return;
            }
            
            // 代理URL校验
            if (enableProxy) {
                if (!proxyTarget) {
                    document.getElementById('proxy-error').textContent = '启用代理模式时，必须设置代理目标URL';
                    document.getElementById('proxy-error').style.display = 'block';
                    return;
                }
                
                try {
                    new URL(proxyTarget);
                } catch (error) {
                    document.getElementById('proxy-error').textContent = '代理目标URL格式不正确';
                    document.getElementById('proxy-error').style.display = 'block';
                    return;
                }
            }
            
            // 构建配置数据
            const configData = {
                server: {
                    host: '0.0.0.0', // 固定为0.0.0.0
                    port: port,
                    enable_https: enableHttps
                },
                proxy: {
                    enable: enableProxy,
                    target_url: proxyTarget
                }
            };
            
            // 保存配置
            fetch('/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer mock_server_admin_token'
                },
                body: JSON.stringify(configData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('保存失败：' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // 显示成功提示
                const saveMessage = document.getElementById('save-message');
                saveMessage.textContent = '配置保存成功！';
                saveMessage.style.backgroundColor = '#d4edda';
                saveMessage.style.color = '#155724';
                saveMessage.style.display = 'block';
                
                // 3秒后隐藏提示
                setTimeout(() => {
                    saveMessage.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                // 显示失败提示
                const saveMessage = document.getElementById('save-message');
                saveMessage.textContent = '配置保存失败：' + error.message;
                saveMessage.style.backgroundColor = '#f8d7da';
                saveMessage.style.color = '#721c24';
                saveMessage.style.display = 'block';
            });
        }
        
        // 关闭模态框
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let i = 0; i < modals.length; i++) {
                const modal = modals[i];
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        }
        
        // 标签页切换
        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // 移除所有标签的激活状态
                document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
                // 添加当前标签的激活状态
                this.classList.add('active');
                
                // 隐藏所有内容
                document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                // 显示对应内容
                const targetId = this.getAttribute('href').substring(1) + '-tab';
                document.getElementById(targetId).style.display = 'block';
                
                // 触发对应页面的分页信息更新
                const tabName = this.getAttribute('href').substring(1);
                if (tabName === 'routes') {
                    // 确保路由管理的分页信息正确
                    initRoutesPagination();
                } else if (tabName === 'requests') {
                    // 确保请求历史的分页信息正确
                    updateRequestsList();
                }
            });
        });
        
        // 通用分页管理器
        class PaginationManager {
            constructor(name, apiPath, tableId, pageSizeId, pageInfoId, firstPageId, prevPageId, nextPageId, lastPageId, sortable = false) {
                this.name = name;
                this.apiPath = apiPath;
                this.tableId = tableId;
                this.pageSizeId = pageSizeId;
                this.pageInfoId = pageInfoId;
                this.firstPageId = firstPageId;
                this.prevPageId = prevPageId;
                this.nextPageId = nextPageId;
                this.lastPageId = lastPageId;
                this.sortable = sortable;
                
                // 分页状态
                this.currentPage = 1;
                this.pageSize = 10;
                this.totalItems = 0;
                this.totalPages = 1;
                this.sortField = sortable ? 'created_at' : '';
                this.sortOrder = sortable ? 'desc' : '';
                
                // 回调函数
                this.onPageChange = null;
                this.onPageSizeChange = null;
            }
            
            // 更新分页UI
            updatePaginationUI() {
                document.getElementById(this.pageInfoId).textContent = `第 ${this.currentPage} 页，共 ${this.totalPages} 页，共 ${this.totalItems} 条`;
                document.getElementById(this.prevPageId).disabled = this.currentPage === 1;
                document.getElementById(this.firstPageId).disabled = this.currentPage === 1;
                document.getElementById(this.nextPageId).disabled = this.currentPage === this.totalPages;
                document.getElementById(this.lastPageId).disabled = this.currentPage === this.totalPages;
            }
            
            // 改变页码
            changePage(page) {
                if (page >= 1 && page <= this.totalPages) {
                    this.currentPage = page;
                    this.updatePaginationUI();
                    // 回调函数，由具体实现提供
                    if (this.onPageChange) {
                        this.onPageChange();
                    }
                }
            }
            
            // 改变每页大小
            changePageSize() {
                this.pageSize = parseInt(document.getElementById(this.pageSizeId).value);
                this.currentPage = 1;
                this.updatePaginationUI();
                // 回调函数，由具体实现提供
                if (this.onPageSizeChange) {
                    this.onPageSizeChange();
                }
            }
            
            // 计算偏移量
            getOffset() {
                return (this.currentPage - 1) * this.pageSize;
            }
            
            // 更新分页信息
            updatePaginationInfo(totalItems) {
                this.totalItems = totalItems;
                this.totalPages = Math.ceil(this.totalItems / this.pageSize);
                // 确保当前页码不超过总页数
                if (this.currentPage > this.totalPages) {
                    this.currentPage = Math.max(1, this.totalPages);
                }
                this.updatePaginationUI();
            }
        }
        
        // 初始化分页管理器
        const routesPagination = new PaginationManager(
            'routes',
            '/admin/routes',
            'routes-table',
            'routes-page-size',
            'routes-page-info',
            'routes-first-page',
            'routes-prev-page',
            'routes-next-page',
            'routes-last-page',
            true
        );
        
        // 设置路由分页回调
        routesPagination.onPageChange = function() {
            updateRoutesList();
        };
        
        routesPagination.onPageSizeChange = function() {
            updateRoutesList();
        };
        
        // 路由排序相关变量
        let routesSortField = 'created_at';
        let routesSortOrder = 'desc';
        
        function initRoutesPagination() {
            const rows = document.querySelectorAll('#routes-table tbody tr');
            routesPagination.updatePaginationInfo(rows.length);
        }
        
        function updateRoutesPaginationUI() {
            routesPagination.updatePaginationUI();
        }
        
        function applyRoutesPagination() {
            const rows = document.querySelectorAll('#routes-table tbody tr');
            const startIndex = (routesPagination.currentPage - 1) * routesPagination.pageSize;
            const endIndex = startIndex + routesPagination.pageSize;
            
            rows.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function changeRoutesPage(page) {
            routesPagination.changePage(page);
        }
        
        function changeRoutesPageSize() {
            routesPagination.changePageSize();
        }
        
        // 路由排序功能
        function sortRoutes(field) {
            // 如果点击的是当前排序字段，切换排序顺序
            if (routesSortField === field) {
                routesSortOrder = routesSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // 否则，设置新的排序字段，默认升序
                routesSortField = field;
                routesSortOrder = 'asc';
            }
            
            // 更新排序图标
            document.querySelectorAll('.sort-icon').forEach(icon => {
                if (icon.dataset.field === field) {
                    icon.textContent = routesSortOrder === 'asc' ? '▲' : '▼';
                    icon.classList.add('active');
                } else {
                    icon.textContent = '▲';
                    icon.classList.remove('active');
                }
            });
            
            // 重置到第一页
            routesPagination.changePage(1);
            
            // 重新获取排序后的数据
            updateRoutesList();
        }
        
        // 初始化请求历史分页管理器
        const requestsPagination = new PaginationManager(
            'requests',
            '/admin/requests',
            'requests-table',
            'requests-page-size',
            'requests-page-info',
            'requests-first-page',
            'requests-prev-page',
            'requests-next-page',
            'requests-last-page',
            true
        );
        
        // 设置请求历史分页回调
        requestsPagination.onPageChange = function() {
            updateRequestsList();
        };
        
        requestsPagination.onPageSizeChange = function() {
            updateRequestsList();
        };
        
        // 请求历史排序相关变量
        let requestsSortField = 'timestamp';
        let requestsSortOrder = 'desc';
        
        // 请求历史排序功能
        function sortRequests(field) {
            // 如果点击的是当前排序字段，切换排序顺序
            if (requestsSortField === field) {
                requestsSortOrder = requestsSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // 否则，设置新的排序字段，默认升序
                requestsSortField = field;
                requestsSortOrder = 'asc';
            }
            
            // 更新排序图标
            document.querySelectorAll('#requests-table .sort-icon').forEach(icon => {
                if (icon.dataset.field === field) {
                    icon.textContent = requestsSortOrder === 'asc' ? '▲' : '▼';
                    icon.classList.add('active');
                } else {
                    icon.textContent = '▲';
                    icon.classList.remove('active');
                }
            });
            
            // 重置到第一页
            requestsPagination.changePage(1);
            
            // 重新获取排序后的数据
            updateRequestsList();
        }
        
        function initRequestsPagination() {
            const rows = document.querySelectorAll('#requests-table tbody tr');
            requestsPagination.updatePaginationInfo(rows.length);
        }
        
        function updateRequestsPaginationUI() {
            requestsPagination.updatePaginationUI();
        }
        
        function applyRequestsPagination() {
            const rows = document.querySelectorAll('#requests-table tbody tr');
            const startIndex = (requestsPagination.currentPage - 1) * requestsPagination.pageSize;
            const endIndex = startIndex + requestsPagination.pageSize;
            
            rows.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function changeRequestsPage(page) {
            requestsPagination.changePage(page);
        }
        
        function changeRequestsPageSize() {
            requestsPagination.changePageSize();
            requestsPageSize = parseInt(document.getElementById('requests-page-size').value);
            requestsCurrentPage = 1;
            
            // 重新获取数据，应用新的每页大小
            const method = document.getElementById('request-method').value;
            const path = document.getElementById('request-path').value;
            const status = document.getElementById('request-status').value;
            
            // 构建查询参数
            let queryParams = new URLSearchParams();
            if (method) {
                queryParams.append('method', method);
            }
            if (path) {
                queryParams.append('path', path);
            }
            if (status) {
                queryParams.append('status_code', status);
            }
            
            // 添加分页参数
            queryParams.append('limit', requestsPageSize);
            queryParams.append('offset', 0); // 重置为第一页
            
            // 从后端获取数据
            fetch(`/admin/requests?${queryParams.toString()}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#requests-table tbody');
                tbody.innerHTML = '';
                
                const requests = data.items || [];
                
                if (requests.length === 0) {
                    // 显示空数据提示
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            <p>暂无请求历史数据</p>
                            <p style="margin-top: 10px;">当有请求访问API时，这里会显示请求历史</p>
                        </td>
                    `;
                    tbody.appendChild(row);
                    
                    // 更新分页信息
                    requestsTotalItems = data.total || 0;
                    requestsTotalPages = Math.ceil(requestsTotalItems / requestsPageSize);
                    // 确保当前页码不超过总页数
                    if (requestsCurrentPage > requestsTotalPages) {
                        requestsCurrentPage = Math.max(1, requestsTotalPages);
                    }
                    updateRequestsPaginationUI();
                } else {
                    // 显示请求历史列表
                    requests.forEach(req => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${timestampToDateTime(req.timestamp)}</td>
                            <td>${req.method}</td>
                            <td>${req.path}</td>
                            <td>${req.response_status}</td>
                            <td>${req.response_time.toFixed(3)}s</td>
                            <td>${req.client_ip}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewRequest('${req.id}')">查看</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // 更新分页信息
                    requestsTotalItems = data.total || requests.length;
                    requestsTotalPages = Math.ceil(requestsTotalItems / requestsPageSize);
                    updateRequestsPaginationUI();
                }
            })
            .catch(error => {
                showToast('更新请求历史失败：' + error.message, 'error');
            });
        }
        
        // 数据统计和分析
        let requestTrendChart = null;
        let methodStatsChart = null;
        
        function updateRequestTrend(hours, interval) {
            console.log('开始更新请求趋势，hours:', hours, 'interval:', interval);
            
            // 检查 Chart 对象是否存在
            if (typeof Chart === 'undefined') {
                console.error('Chart.js 加载失败，无法初始化图表');
                return;
            }
            
            // 检查图表元素是否存在
            const chartElement = document.getElementById('request-trend-chart');
            if (!chartElement) {
                console.error('请求趋势图表元素不存在');
                return;
            }
            
            fetch(`/admin/analytics/request-trend?hours=${hours}&interval=${interval}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => {
                console.log('获取请求趋势响应：', response);
                return response.json();
            })
            .then(data => {
                console.log('获取请求趋势数据：', data);
                
                // 再次检查 Chart 对象是否存在
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js 加载失败，无法初始化图表');
                    return;
                }
                
                // 再次检查图表元素是否存在
                if (!document.getElementById('request-trend-chart')) {
                    console.error('请求趋势图表元素不存在');
                    return;
                }
                
                const ctx = chartElement.getContext('2d');
                console.log('获取图表上下文：', ctx);
                
                if (requestTrendChart) {
                    console.log('销毁现有图表');
                    requestTrendChart.destroy();
                }
                
                console.log('创建新图表');
                
                // 处理响应时间数据和单位
                let responseTimes = data.response_times;
                let timeUnit = 'ms';
                let timeLabel = '平均响应时间 (ms)';
                let axisLabel = '响应时间 (ms)';
                
                // 检查是否需要使用秒作为单位
                const hasLargeValues = responseTimes.some(time => time >= 1);
                if (hasLargeValues) {
                    timeUnit = 's';
                    timeLabel = '平均响应时间 (s)';
                    axisLabel = '响应时间 (s)';
                } else {
                    // 转换为毫秒
                    responseTimes = responseTimes.map(time => time * 1000);
                }
                
                // 根据时间范围和数据点数量计算横坐标间隔
                let maxLabels = 12; // 最大显示12个标签
                let stepSize = 1;
                if (data.labels.length > maxLabels) {
                    stepSize = Math.ceil(data.labels.length / maxLabels);
                }
                
                requestTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: '请求数',
                            data: data.request_counts,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: timeLabel,
                            data: responseTimes,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '请求数'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: axisLabel
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: true,
                                    maxTicksLimit: maxLabels,
                                    stepSize: stepSize
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        // 显示对应时间点，而不是整点
                                        if (data.time_points && data.time_points[context[0].dataIndex]) {
                                            return data.time_points[context[0].dataIndex];
                                        }
                                        return context[0].label;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('请求趋势图表创建完成');
            })
            .catch(error => {
                console.error('获取请求趋势失败：', error);
            });
        }
        
        function updateResponseTimeStats(hours) {
            fetch(`/admin/analytics/response-time?hours=${hours}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('avg-response-time').textContent = (data.avg_response_time * 1000).toFixed(2);
                document.getElementById('min-response-time').textContent = (data.min_response_time * 1000).toFixed(2);
                document.getElementById('max-response-time').textContent = (data.max_response_time * 1000).toFixed(2);
                document.getElementById('p95-response-time').textContent = (data.p95_response_time * 1000).toFixed(2);
            })
            .catch(error => {
                console.error('获取响应时间统计失败：', error);
            });
        }
        
        function updateStatusCodeStats(hours) {
            fetch(`/admin/analytics/status-codes?hours=${hours}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('status-2xx').textContent = data.status_categories['2xx'] || 0;
                document.getElementById('status-3xx').textContent = data.status_categories['3xx'] || 0;
                document.getElementById('status-4xx').textContent = data.status_categories['4xx'] || 0;
                document.getElementById('status-5xx').textContent = data.status_categories['5xx'] || 0;
            })
            .catch(error => {
                console.error('获取状态码统计失败：', error);
            });
        }
        
        function updateMethodStats(hours) {
            console.log('开始更新请求方法统计，hours:', hours);
            
            // 检查 Chart 对象是否存在
            if (typeof Chart === 'undefined') {
                console.error('Chart.js 加载失败，无法初始化图表');
                return;
            }
            
            // 检查图表元素是否存在
            const chartElement = document.getElementById('method-stats-chart');
            if (!chartElement) {
                console.error('请求方法统计图表元素不存在');
                return;
            }
            
            fetch(`/admin/analytics/methods?hours=${hours}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => {
                console.log('获取请求方法统计响应：', response);
                return response.json();
            })
            .then(data => {
                console.log('获取请求方法统计数据：', data);
                
                // 再次检查 Chart 对象是否存在
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js 加载失败，无法初始化图表');
                    return;
                }
                
                // 再次检查图表元素是否存在
                if (!document.getElementById('method-stats-chart')) {
                    console.error('请求方法统计图表元素不存在');
                    return;
                }
                
                const ctx = chartElement.getContext('2d');
                console.log('获取图表上下文：', ctx);
                
                if (methodStatsChart) {
                    console.log('销毁现有图表');
                    methodStatsChart.destroy();
                }
                
                console.log('创建新图表');
                methodStatsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.method_counts),
                        datasets: [{
                            label: '请求数',
                            data: Object.values(data.method_counts),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                console.log('请求方法统计图表创建完成');
            })
            .catch(error => {
                console.error('获取请求方法统计失败：', error);
            });
        }
        
        function updateHotPaths(hours) {
            fetch(`/admin/analytics/paths?hours=${hours}&limit=10`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#hot-paths-table tbody');
                tbody.innerHTML = '';
                
                if (data.top_paths.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3">暂无数据</td></tr>';
                    return;
                }
                
                data.top_paths.forEach(path => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${path.path}</td>
                        <td>${path.count}</td>
                        <td>${(path.avg_response_time * 1000).toFixed(2)}ms</td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('获取热门路径失败：', error);
            });
        }
        
        function updateAnalytics() {
            const hours = parseInt(document.getElementById('analytics-hours').value);
            
            // 根据时间范围确定时间间隔
            let interval = 'hour';
            if (hours <= 1) {
                // 1小时或更少，使用分钟作为时间间隔
                interval = 'minute';
            } else {
                // 1小时以上，使用小时作为时间间隔
                interval = 'hour';
            }
            
            // 更新请求趋势
            updateRequestTrend(hours, interval);
            
            // 更新响应时间统计
            updateResponseTimeStats(hours);
            
            // 更新状态码统计
            updateStatusCodeStats(hours);
            
            // 更新请求方法统计
            updateMethodStats(hours);
            
            // 更新热门路径
            updateHotPaths(hours);
        }
        
        // 初始化分页
        document.addEventListener('DOMContentLoaded', function() {
            // 首次加载路由列表
            updateRoutesList();
            // 首次加载请求历史列表
            updateRequestsList();
            
            // 确保 Chart.js 加载完成后再初始化图表
            function checkChartLoaded() {
                if (typeof Chart !== 'undefined') {
                    console.log('Chart.js 加载完成，初始化图表');
                    updateAnalytics();
                } else {
                    console.log('Chart.js 尚未加载，等待...');
                    // 等待 Chart.js 加载完成，最多尝试 5 次
                    setTimeout(checkChartLoaded, 1000);
                }
            }
            
            checkChartLoaded();
        });
    </script>
    
    <!-- 版权信息 -->
    <footer style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-top: 1px solid #dee2e6; text-align: center;">
        <p>&copy; <span id="current-year"></span>  Mock Server. Gavin Wang All rights reserved.</p>
    </footer>
    
    <script>
        // 设置当前年份
        document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>
</body>
</html>