<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mock Server 管理界面</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #333;
            color: #fff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        nav {
            background-color: #444;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        nav ul {
            list-style: none;
            display: flex;
            gap: 15px;
        }
        
        nav ul li a {
            color: #fff;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: #555;
        }
        
        nav ul li a.active {
            background-color: #007bff;
            color: #fff;
        }
        
        .section {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: #fff;
        }
        
        .btn-primary:hover {
            background-color: #0069d9;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: #fff;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: #fff;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-enabled {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-disabled {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .filter-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-form input, .filter-form select {
            flex: 1;
            min-width: 150px;
        }
        
        .request-detail {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        
        .request-detail pre {
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            nav ul {
                flex-direction: column;
                gap: 5px;
            }
            
            .filter-form {
                flex-direction: column;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Mock Server 管理界面</h1>
            <p>企业级Python Mock Server - 版本 1.0.0</p>
        </header>
        
        <nav>
            <ul>
                <li><a href="#routes" class="tab-link active">路由管理</a></li>
                <li><a href="#requests" class="tab-link">请求历史</a></li>
                <li><a href="#config" class="tab-link">服务配置</a></li>
                <li><a href="#status" class="tab-link">服务状态</a></li>
            </ul>
        </nav>
        
        <!-- 路由管理 -->
        <div class="tab-content" id="routes-tab" style="display: block;">
            <h2>路由管理</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="openCreateRouteModal()">创建新路由</button>
                <div>
                    <input type="text" id="route-search" placeholder="搜索路由..." style="padding: 8px; width: 200px;">
                    <button class="btn btn-secondary" onclick="searchRoutes()">搜索</button>
                </div>
            </div>
            
            <table id="routes-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>路径</th>
                        <th>方法</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for route in routes %}
                    <tr>
                        <td>{{ route.id[:8] }}...</td>
                        <td>{{ route.name }}</td>
                        <td>{{ route.match_rule.path }}</td>
                        <td>{{ route.match_rule.methods | join(', ') }}</td>
                        <td>
                            <span class="status-badge {{ 'status-enabled' if route.enabled else 'status-disabled' }}">
                                {{ '启用' if route.enabled else '禁用' }}
                            </span>
                        </td>
                        <td>{{ route.created_at | int | timestamp }}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editRoute('{{ route.id }}')">编辑</button>
                            <button class="btn btn-danger" onclick="deleteRoute('{{ route.id }}')">删除</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- 分页控件 -->
            <div class="pagination-controls" style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <label>每页显示：</label>
                    <select id="routes-page-size" onchange="changeRoutesPageSize()">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="changeRoutesPage(1)" id="routes-first-page">首页</button>
                    <button class="btn btn-secondary" onclick="changeRoutesPage(routesCurrentPage - 1)" id="routes-prev-page">上一页</button>
                    <span id="routes-page-info">第 1 页，共 1 页</span>
                    <button class="btn btn-secondary" onclick="changeRoutesPage(routesCurrentPage + 1)" id="routes-next-page">下一页</button>
                    <button class="btn btn-secondary" onclick="changeRoutesPage(routesTotalPages)" id="routes-last-page">末页</button>
                </div>
            </div>
        </div>
        
        <!-- 请求历史 -->
        <div class="tab-content" id="requests-tab" style="display: none;">
            <h2>请求历史</h2>
            <div class="filter-form">
                <select id="request-method" placeholder="方法">
                    <option value="">所有方法</option>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                </select>
                <input type="text" id="request-path" placeholder="路径包含">
                <input type="number" id="request-status" placeholder="状态码">
                <button class="btn btn-primary" onclick="filterRequests()">过滤</button>
                <button class="btn btn-secondary" onclick="clearFilters()">清空</button>
                <button class="btn btn-danger" onclick="clearRequests()">清空历史</button>
            </div>
            
            <table id="requests-table">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>方法</th>
                        <th>路径</th>
                        <th>状态码</th>
                        <th>响应时间</th>
                        <th>客户端IP</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr>
                        <td>{{ req.timestamp | int | timestamp }}</td>
                        <td>{{ req.method }}</td>
                        <td>{{ req.path }}</td>
                        <td>{{ req.response_status }}</td>
                        <td>{{ "{:.3f}".format(req.response_time) }}s</td>
                        <td>{{ req.client_ip }}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewRequest('{{ req.id }}')">查看</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- 分页控件 -->
            <div class="pagination-controls" style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <label>每页显示：</label>
                    <select id="requests-page-size" onchange="changeRequestsPageSize()">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="changeRequestsPage(1)" id="requests-first-page">首页</button>
                    <button class="btn btn-secondary" onclick="changeRequestsPage(requestsCurrentPage - 1)" id="requests-prev-page">上一页</button>
                    <span id="requests-page-info">第 1 页，共 1 页</span>
                    <button class="btn btn-secondary" onclick="changeRequestsPage(requestsCurrentPage + 1)" id="requests-next-page">下一页</button>
                    <button class="btn btn-secondary" onclick="changeRequestsPage(requestsTotalPages)" id="requests-last-page">末页</button>
                </div>
            </div>
        </div>
        
        <!-- 服务配置 -->
        <div class="tab-content" id="config-tab" style="display: none;">
            <h2>服务配置</h2>
            <form id="config-form">
                <div class="form-group">
                    <label>服务器地址</label>
                    <input type="text" id="server-host" value="0.0.0.0" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label>服务器端口</label>
                    <input type="number" id="server-port" value="{{ config.server.port }}" min="1" max="65535">
                    <small id="port-error" style="color: red; display: none;"></small>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="enable-https" {% if config.server.enable_https %}checked{% endif %}>
                    <label for="enable-https" style="margin-bottom: 0;">启用HTTPS</label>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="enable-proxy" {% if config.proxy.enable %}checked{% endif %} onchange="toggleProxyInput()">
                    <label for="enable-proxy" style="margin-bottom: 0;">启用代理模式</label>
                </div>
                <div class="form-group">
                    <label>代理目标URL</label>
                    <input type="text" id="proxy-target" value="{{ config.proxy.target_url or '' }}" {% if not config.proxy.enable %}disabled style="background-color: #f5f5f5; cursor: not-allowed;"{% endif %}>
                    <small id="proxy-error" style="color: red; display: none;"></small>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">保存配置</button>
                    <button type="button" class="btn btn-secondary" onclick="restoreDefaultConfig()">恢复默认</button>
                </div>
                <div id="save-message" style="margin-top: 10px; padding: 10px; border-radius: 3px; display: none;"></div>
            </form>
        </div>
        
        <!-- 服务状态 -->
        <div class="tab-content" id="status-tab" style="display: none;">
            <h2>服务状态</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="request-detail">
                    <h3>运行时间</h3>
                    <p id="uptime">计算中...</p>
                </div>
                <div class="request-detail">
                    <h3>总请求数</h3>
                    <p id="total-requests">{{ requests | length }}</p>
                </div>
                <div class="request-detail">
                    <h3>活跃路由</h3>
                    <p id="active-routes">{{ routes | selectattr('enabled', 'equalto', true) | list | length }}</p>
                </div>
                <div class="request-detail">
                    <h3>服务状态</h3>
                    <p id="service-status" class="status-badge status-enabled">运行中</p>
                </div>
            </div>
            
            <!-- 数据统计和分析 -->
            <h3>数据统计和分析</h3>
            <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; white-space: nowrap;">
                <label style="font-weight: normal;">统计时间范围：</label>
                <select id="analytics-hours" onchange="updateAnalytics()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 3px; width: 120px;">
                    <option value="1" selected>1小时</option>
                    <option value="6">6小时</option>
                    <option value="24">24小时</option>
                    <option value="48">48小时</option>
                    <option value="72">72小时</option>
                    <option value="168">7天</option>
                </select>
                <button class="btn btn-primary" onclick="updateAnalytics()" style="background-color: #1890ff; border-color: #1890ff;">更新数据</button>
            </div>
            
            <!-- 请求趋势图表 -->
            <div class="request-detail" style="margin-bottom: 20px;">
                <h4>请求趋势</h4>
                <div style="width: 100%; height: 300px;">
                    <canvas id="request-trend-chart"></canvas>
                </div>
            </div>
            
            <!-- 响应时间统计 -->
            <div class="request-detail" style="margin-bottom: 20px;">
                <h4>响应时间统计</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <p><strong>平均响应时间：</strong><span id="avg-response-time">0</span>ms</p>
                    </div>
                    <div>
                        <p><strong>最小响应时间：</strong><span id="min-response-time">0</span>ms</p>
                    </div>
                    <div>
                        <p><strong>最大响应时间：</strong><span id="max-response-time">0</span>ms</p>
                    </div>
                    <div>
                        <p><strong>P95响应时间：</strong><span id="p95-response-time">0</span>ms</p>
                    </div>
                </div>
            </div>
            
            <!-- 状态码统计 -->
            <div class="request-detail" style="margin-bottom: 20px;">
                <h4>状态码统计</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                    <div>
                        <p><strong>2xx：</strong><span id="status-2xx">0</span></p>
                    </div>
                    <div>
                        <p><strong>3xx：</strong><span id="status-3xx">0</span></p>
                    </div>
                    <div>
                        <p><strong>4xx：</strong><span id="status-4xx">0</span></p>
                    </div>
                    <div>
                        <p><strong>5xx：</strong><span id="status-5xx">0</span></p>
                    </div>
                </div>
            </div>
            
            <!-- 请求方法统计 -->
            <div class="request-detail" style="margin-bottom: 20px;">
                <h4>请求方法统计</h4>
                <div style="width: 100%; height: 300px;">
                    <canvas id="method-stats-chart"></canvas>
                </div>
            </div>
            
            <!-- 热门路径统计 -->
            <div class="request-detail" style="margin-bottom: 20px;">
                <h4>热门路径</h4>
                <table id="hot-paths-table">
                    <thead>
                        <tr>
                            <th>路径</th>
                            <th>请求数</th>
                            <th>平均响应时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 创建路由模态框 -->
    <div id="create-route-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateRouteModal()">&times;</span>
            <h2>创建新路由</h2>
            <form id="create-route-form">
                <div class="form-group">
                    <label>路由名称</label>
                    <input type="text" id="route-name" required>
                </div>
                <div class="form-group">
                    <label>路径</label>
                    <input type="text" id="route-path" placeholder="例如: /api/users/{id}" required>
                </div>
                <div class="form-group">
                    <label>HTTP方法</label>
                    <input type="text" id="route-methods" placeholder="例如: GET,POST" required>
                </div>
                <div class="form-group">
                    <label>状态码</label>
                    <input type="number" id="route-status" value="200" required>
                </div>
                <div class="form-group">
                    <label>响应内容</label>
                    <textarea id="route-content" placeholder='例如: {"id": "1", "name": "User"}' required></textarea>
                </div>
                <div class="form-group">
                    <label>响应延迟 (秒)</label>
                    <input type="number" id="route-delay" value="0" step="0.1">
                </div>
                <button type="button" class="btn btn-primary" onclick="submitCreateRoute()">创建</button>
                <button type="button" class="btn btn-secondary" onclick="closeCreateRouteModal()">取消</button>
            </form>
        </div>
    </div>
    
    <!-- 请求详情模态框 -->
    <div id="request-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRequestDetailModal()">&times;</span>
            <h2>请求详情</h2>
            <div id="request-detail-content"></div>
        </div>
    </div>
    
    <script>
        // 时间戳转换为日期时间
        function timestampToDateTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('zh-CN');
        }
        
        // 格式化时间戳
        document.addEventListener('DOMContentLoaded', function() {
            // 计算运行时间
            updateUptime();
            setInterval(updateUptime, 1000);
            
            // 搜索路由
            document.getElementById('route-search').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchRoutes();
                }
            });
        });
        
        function updateUptime() {
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    const uptime = data.uptime;
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    const seconds = Math.floor(uptime % 60);
                    document.getElementById('uptime').textContent = `${hours}h ${minutes}m ${seconds}s`;
                });
        }
        
        // 路由管理
        function openCreateRouteModal() {
            document.getElementById('create-route-modal').style.display = 'block';
        }
        
        function closeCreateRouteModal() {
            document.getElementById('create-route-modal').style.display = 'none';
            document.getElementById('create-route-form').reset();
        }
        
        function submitCreateRoute() {
            const name = document.getElementById('route-name').value;
            const path = document.getElementById('route-path').value;
            const methods = document.getElementById('route-methods').value.split(',').map(m => m.trim());
            const status = parseInt(document.getElementById('route-status').value);
            const content = document.getElementById('route-content').value;
            const delay = parseFloat(document.getElementById('route-delay').value);
            
            const routeData = {
                name: name,
                match_rule: {
                    path: path,
                    methods: methods
                },
                response: {
                    status_code: status,
                    content: JSON.parse(content),
                    delay: delay
                }
            };
            
            fetch('/admin/routes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer mock_server_admin_token'
                },
                body: JSON.stringify(routeData)
            })
            .then(response => response.json())
            .then(data => {
                alert('路由创建成功！');
                closeCreateRouteModal();
                location.reload();
            })
            .catch(error => {
                alert('路由创建失败：' + error.message);
            });
        }
        
        function editRoute(routeId) {
            alert('编辑路由功能开发中...');
        }
        
        function deleteRoute(routeId) {
            if (confirm('确定要删除此路由吗？')) {
                fetch(`/admin/routes/${routeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer mock_server_admin_token'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    alert('路由删除成功！');
                    location.reload();
                })
                .catch(error => {
                    alert('路由删除失败：' + error.message);
                });
            }
        }
        
        function searchRoutes() {
            const searchTerm = document.getElementById('route-search').value.toLowerCase();
            const rows = document.querySelectorAll('#routes-table tbody tr');
            
            rows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const path = row.cells[2].textContent.toLowerCase();
                const methods = row.cells[3].textContent.toLowerCase();
                
                if (name.includes(searchTerm) || path.includes(searchTerm) || methods.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // 请求历史管理
        function filterRequests() {
            const method = document.getElementById('request-method').value;
            const path = document.getElementById('request-path').value.toLowerCase();
            const status = document.getElementById('request-status').value;
            
            const rows = document.querySelectorAll('#requests-table tbody tr');
            
            rows.forEach(row => {
                const rowMethod = row.cells[1].textContent;
                const rowPath = row.cells[2].textContent.toLowerCase();
                const rowStatus = row.cells[3].textContent;
                
                const methodMatch = !method || rowMethod === method;
                const pathMatch = !path || rowPath.includes(path);
                const statusMatch = !status || rowStatus === status;
                
                if (methodMatch && pathMatch && statusMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function clearFilters() {
            document.getElementById('request-method').value = '';
            document.getElementById('request-path').value = '';
            document.getElementById('request-status').value = '';
            filterRequests();
        }
        
        function clearRequests() {
            if (confirm('确定要清空所有请求历史吗？')) {
                fetch('/admin/requests', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer mock_server_admin_token'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    alert('请求历史清空成功！');
                    location.reload();
                })
                .catch(error => {
                    alert('请求历史清空失败：' + error.message);
                });
            }
        }
        
        function viewRequest(requestId) {
            fetch(`/admin/requests/${requestId}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                const modal = document.getElementById('request-detail-modal');
                const content = document.getElementById('request-detail-content');
                
                content.innerHTML = `
                    <div class="request-detail">
                        <h3>请求信息</h3>
                        <p><strong>时间：</strong>${timestampToDateTime(data.request.timestamp)}</p>
                        <p><strong>方法：</strong>${data.request.method}</p>
                        <p><strong>路径：</strong>${data.request.path}</p>
                        <p><strong>状态码：</strong>${data.request.response_status}</p>
                        <p><strong>响应时间：</strong>${data.request.response_time}s</p>
                        <p><strong>客户端IP：</strong>${data.request.client_ip}</p>
                        <p><strong>查询参数：</strong></p>
                        <pre>${JSON.stringify(data.request.query_params, null, 2)}</pre>
                        <p><strong>请求体：</strong></p>
                        <pre>${JSON.stringify(data.request.body, null, 2)}</pre>
                    </div>
                    <div class="request-detail" style="margin-top: 10px;">
                        <h3>响应信息</h3>
                        <p><strong>状态码：</strong>${data.response.status_code}</p>
                        <p><strong>响应时间：</strong>${data.response.response_time}s</p>
                        <p><strong>内容类型：</strong>${data.response.content_type}</p>
                        <p><strong>响应内容：</strong></p>
                        <pre>${JSON.stringify(data.response.content, null, 2)}</pre>
                    </div>
                `;
                
                modal.style.display = 'block';
            })
            .catch(error => {
                alert('获取请求详情失败：' + error.message);
            });
        }
        
        function closeRequestDetailModal() {
            document.getElementById('request-detail-modal').style.display = 'none';
        }
        
        // 切换代理输入框状态
        function toggleProxyInput() {
            const enableProxy = document.getElementById('enable-proxy').checked;
            const proxyTarget = document.getElementById('proxy-target');
            
            if (enableProxy) {
                proxyTarget.disabled = false;
                proxyTarget.style.backgroundColor = '#ffffff';
                proxyTarget.style.cursor = 'text';
            } else {
                proxyTarget.disabled = true;
                proxyTarget.style.backgroundColor = '#f5f5f5';
                proxyTarget.style.cursor = 'not-allowed';
            }
        }
        
        // 恢复默认配置
        function restoreDefaultConfig() {
            if (confirm('确定要恢复默认配置吗？这将覆盖当前的所有配置设置。')) {
                // 默认配置
                const defaultConfig = {
                    server: {
                        host: '0.0.0.0',
                        port: 8080,
                        enable_https: false
                    },
                    proxy: {
                        enable: false,
                        target_url: ''
                    }
                };
                
                // 更新表单
                document.getElementById('server-port').value = defaultConfig.server.port;
                document.getElementById('enable-https').checked = defaultConfig.server.enable_https;
                document.getElementById('enable-proxy').checked = defaultConfig.proxy.enable;
                document.getElementById('proxy-target').value = defaultConfig.proxy.target_url;
                
                // 切换代理输入框状态
                toggleProxyInput();
                
                // 保存默认配置
                fetch('/admin/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer mock_server_admin_token'
                    },
                    body: JSON.stringify(defaultConfig)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('保存失败：' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    // 显示成功提示
                    const saveMessage = document.getElementById('save-message');
                    saveMessage.textContent = '默认配置恢复成功！';
                    saveMessage.style.backgroundColor = '#d4edda';
                    saveMessage.style.color = '#155724';
                    saveMessage.style.display = 'block';
                    
                    // 3秒后隐藏提示
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                    }, 3000);
                })
                .catch(error => {
                    // 显示失败提示
                    const saveMessage = document.getElementById('save-message');
                    saveMessage.textContent = '默认配置恢复失败：' + error.message;
                    saveMessage.style.backgroundColor = '#f8d7da';
                    saveMessage.style.color = '#721c24';
                    saveMessage.style.display = 'block';
                });
            }
        }
        
        // 服务配置管理
        function saveConfig() {
            // 重置错误提示
            document.getElementById('port-error').style.display = 'none';
            document.getElementById('proxy-error').style.display = 'none';
            document.getElementById('save-message').style.display = 'none';
            
            // 获取表单数据
            const port = parseInt(document.getElementById('server-port').value);
            const enableHttps = document.getElementById('enable-https').checked;
            const enableProxy = document.getElementById('enable-proxy').checked;
            const proxyTarget = document.getElementById('proxy-target').value;
            
            // 端口校验
            if (isNaN(port) || port < 1 || port > 65535) {
                document.getElementById('port-error').textContent = '端口号必须在1-65535之间';
                document.getElementById('port-error').style.display = 'block';
                return;
            }
            
            // 代理URL校验
            if (enableProxy) {
                if (!proxyTarget) {
                    document.getElementById('proxy-error').textContent = '启用代理模式时，必须设置代理目标URL';
                    document.getElementById('proxy-error').style.display = 'block';
                    return;
                }
                
                try {
                    new URL(proxyTarget);
                } catch (error) {
                    document.getElementById('proxy-error').textContent = '代理目标URL格式不正确';
                    document.getElementById('proxy-error').style.display = 'block';
                    return;
                }
            }
            
            // 构建配置数据
            const configData = {
                server: {
                    host: '0.0.0.0', // 固定为0.0.0.0
                    port: port,
                    enable_https: enableHttps
                },
                proxy: {
                    enable: enableProxy,
                    target_url: proxyTarget
                }
            };
            
            // 保存配置
            fetch('/admin/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer mock_server_admin_token'
                },
                body: JSON.stringify(configData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('保存失败：' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // 显示成功提示
                const saveMessage = document.getElementById('save-message');
                saveMessage.textContent = '配置保存成功！';
                saveMessage.style.backgroundColor = '#d4edda';
                saveMessage.style.color = '#155724';
                saveMessage.style.display = 'block';
                
                // 3秒后隐藏提示
                setTimeout(() => {
                    saveMessage.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                // 显示失败提示
                const saveMessage = document.getElementById('save-message');
                saveMessage.textContent = '配置保存失败：' + error.message;
                saveMessage.style.backgroundColor = '#f8d7da';
                saveMessage.style.color = '#721c24';
                saveMessage.style.display = 'block';
            });
        }
        
        // 关闭模态框
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let i = 0; i < modals.length; i++) {
                const modal = modals[i];
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        }
        
        // 标签页切换
        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // 移除所有标签的激活状态
                document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
                // 添加当前标签的激活状态
                this.classList.add('active');
                
                // 隐藏所有内容
                document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                // 显示对应内容
                const targetId = this.getAttribute('href').substring(1) + '-tab';
                document.getElementById(targetId).style.display = 'block';
            });
        });
        
        // 路由管理分页
        let routesCurrentPage = 1;
        let routesPageSize = 10;
        let routesTotalItems = 0;
        let routesTotalPages = 0;
        
        function initRoutesPagination() {
            const rows = document.querySelectorAll('#routes-table tbody tr');
            routesTotalItems = rows.length;
            routesTotalPages = Math.ceil(routesTotalItems / routesPageSize);
            updateRoutesPaginationUI();
            applyRoutesPagination();
        }
        
        function updateRoutesPaginationUI() {
            document.getElementById('routes-page-info').textContent = `第 ${routesCurrentPage} 页，共 ${routesTotalPages} 页`;
            document.getElementById('routes-prev-page').disabled = routesCurrentPage === 1;
            document.getElementById('routes-first-page').disabled = routesCurrentPage === 1;
            document.getElementById('routes-next-page').disabled = routesCurrentPage === routesTotalPages;
            document.getElementById('routes-last-page').disabled = routesCurrentPage === routesTotalPages;
        }
        
        function applyRoutesPagination() {
            const rows = document.querySelectorAll('#routes-table tbody tr');
            const startIndex = (routesCurrentPage - 1) * routesPageSize;
            const endIndex = startIndex + routesPageSize;
            
            rows.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function changeRoutesPage(page) {
            if (page >= 1 && page <= routesTotalPages) {
                routesCurrentPage = page;
                updateRoutesPaginationUI();
                applyRoutesPagination();
            }
        }
        
        function changeRoutesPageSize() {
            routesPageSize = parseInt(document.getElementById('routes-page-size').value);
            routesCurrentPage = 1;
            initRoutesPagination();
        }
        
        // 请求历史分页
        let requestsCurrentPage = 1;
        let requestsPageSize = 10;
        let requestsTotalItems = 0;
        let requestsTotalPages = 0;
        
        function initRequestsPagination() {
            const rows = document.querySelectorAll('#requests-table tbody tr');
            requestsTotalItems = rows.length;
            requestsTotalPages = Math.ceil(requestsTotalItems / requestsPageSize);
            updateRequestsPaginationUI();
            applyRequestsPagination();
        }
        
        function updateRequestsPaginationUI() {
            document.getElementById('requests-page-info').textContent = `第 ${requestsCurrentPage} 页，共 ${requestsTotalPages} 页`;
            document.getElementById('requests-prev-page').disabled = requestsCurrentPage === 1;
            document.getElementById('requests-first-page').disabled = requestsCurrentPage === 1;
            document.getElementById('requests-next-page').disabled = requestsCurrentPage === requestsTotalPages;
            document.getElementById('requests-last-page').disabled = requestsCurrentPage === requestsTotalPages;
        }
        
        function applyRequestsPagination() {
            const rows = document.querySelectorAll('#requests-table tbody tr');
            const startIndex = (requestsCurrentPage - 1) * requestsPageSize;
            const endIndex = startIndex + requestsPageSize;
            
            rows.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function changeRequestsPage(page) {
            if (page >= 1 && page <= requestsTotalPages) {
                requestsCurrentPage = page;
                updateRequestsPaginationUI();
                applyRequestsPagination();
            }
        }
        
        function changeRequestsPageSize() {
            requestsPageSize = parseInt(document.getElementById('requests-page-size').value);
            requestsCurrentPage = 1;
            initRequestsPagination();
        }
        
        // 数据统计和分析
        let requestTrendChart = null;
        let methodStatsChart = null;
        
        function updateRequestTrend(hours, interval) {
            console.log('开始更新请求趋势，hours:', hours, 'interval:', interval);
            fetch(`/admin/analytics/request-trend?hours=${hours}&interval=${interval}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => {
                console.log('获取请求趋势响应：', response);
                return response.json();
            })
            .then(data => {
                console.log('获取请求趋势数据：', data);
                const ctx = document.getElementById('request-trend-chart').getContext('2d');
                console.log('获取图表上下文：', ctx);
                
                if (requestTrendChart) {
                    console.log('销毁现有图表');
                    requestTrendChart.destroy();
                }
                
                console.log('创建新图表');
                
                // 处理响应时间数据和单位
                let responseTimes = data.response_times;
                let timeUnit = 'ms';
                let timeLabel = '平均响应时间 (ms)';
                let axisLabel = '响应时间 (ms)';
                
                // 检查是否需要使用秒作为单位
                const hasLargeValues = responseTimes.some(time => time >= 1);
                if (hasLargeValues) {
                    timeUnit = 's';
                    timeLabel = '平均响应时间 (s)';
                    axisLabel = '响应时间 (s)';
                } else {
                    // 转换为毫秒
                    responseTimes = responseTimes.map(time => time * 1000);
                }
                
                // 根据时间范围和数据点数量计算横坐标间隔
                let maxLabels = 12; // 最大显示12个标签
                let stepSize = 1;
                if (data.labels.length > maxLabels) {
                    stepSize = Math.ceil(data.labels.length / maxLabels);
                }
                
                requestTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: '请求数',
                            data: data.request_counts,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: timeLabel,
                            data: responseTimes,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '请求数'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: axisLabel
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: true,
                                    maxTicksLimit: maxLabels,
                                    stepSize: stepSize
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        // 显示对应时间点，而不是整点
                                        if (data.time_points && data.time_points[context[0].dataIndex]) {
                                            return data.time_points[context[0].dataIndex];
                                        }
                                        return context[0].label;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('请求趋势图表创建完成');
            })
            .catch(error => {
                console.error('获取请求趋势失败：', error);
            });
        }
        
        function updateResponseTimeStats(hours) {
            fetch(`/admin/analytics/response-time?hours=${hours}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('avg-response-time').textContent = (data.avg_response_time * 1000).toFixed(2);
                document.getElementById('min-response-time').textContent = (data.min_response_time * 1000).toFixed(2);
                document.getElementById('max-response-time').textContent = (data.max_response_time * 1000).toFixed(2);
                document.getElementById('p95-response-time').textContent = (data.p95_response_time * 1000).toFixed(2);
            })
            .catch(error => {
                console.error('获取响应时间统计失败：', error);
            });
        }
        
        function updateStatusCodeStats(hours) {
            fetch(`/admin/analytics/status-codes?hours=${hours}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('status-2xx').textContent = data.status_categories['2xx'] || 0;
                document.getElementById('status-3xx').textContent = data.status_categories['3xx'] || 0;
                document.getElementById('status-4xx').textContent = data.status_categories['4xx'] || 0;
                document.getElementById('status-5xx').textContent = data.status_categories['5xx'] || 0;
            })
            .catch(error => {
                console.error('获取状态码统计失败：', error);
            });
        }
        
        function updateMethodStats(hours) {
            console.log('开始更新请求方法统计，hours:', hours);
            fetch(`/admin/analytics/methods?hours=${hours}`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => {
                console.log('获取请求方法统计响应：', response);
                return response.json();
            })
            .then(data => {
                console.log('获取请求方法统计数据：', data);
                const ctx = document.getElementById('method-stats-chart').getContext('2d');
                console.log('获取图表上下文：', ctx);
                
                if (methodStatsChart) {
                    console.log('销毁现有图表');
                    methodStatsChart.destroy();
                }
                
                console.log('创建新图表');
                methodStatsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.method_counts),
                        datasets: [{
                            label: '请求数',
                            data: Object.values(data.method_counts),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                console.log('请求方法统计图表创建完成');
            })
            .catch(error => {
                console.error('获取请求方法统计失败：', error);
            });
        }
        
        function updateHotPaths(hours) {
            fetch(`/admin/analytics/paths?hours=${hours}&limit=10`, {
                headers: {
                    'Authorization': 'Bearer mock_server_admin_token'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#hot-paths-table tbody');
                tbody.innerHTML = '';
                
                if (data.top_paths.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3">暂无数据</td></tr>';
                    return;
                }
                
                data.top_paths.forEach(path => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${path.path}</td>
                        <td>${path.count}</td>
                        <td>${(path.avg_response_time * 1000).toFixed(2)}ms</td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('获取热门路径失败：', error);
            });
        }
        
        function updateAnalytics() {
            const hours = parseInt(document.getElementById('analytics-hours').value);
            
            // 根据时间范围确定时间间隔
            let interval = 'hour';
            if (hours <= 1) {
                // 1小时或更少，使用分钟作为时间间隔
                interval = 'minute';
            } else {
                // 1小时以上，使用小时作为时间间隔
                interval = 'hour';
            }
            
            // 更新请求趋势
            updateRequestTrend(hours, interval);
            
            // 更新响应时间统计
            updateResponseTimeStats(hours);
            
            // 更新状态码统计
            updateStatusCodeStats(hours);
            
            // 更新请求方法统计
            updateMethodStats(hours);
            
            // 更新热门路径
            updateHotPaths(hours);
        }
        
        // 初始化分页
        document.addEventListener('DOMContentLoaded', function() {
            initRoutesPagination();
            initRequestsPagination();
            updateAnalytics();
        });
    </script>
</body>
</html>